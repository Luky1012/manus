<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-color: #ddd;
            --text-color: #333;
            --text-light: #777;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .tabs {
            display: flex;
            margin-top: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: 500;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 5px 5px;
            box-shadow: var(--shadow);
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .card-body {
            padding: 20px;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .control-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .control-value {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background-color: var(--secondary-color);
        }

        .status-disconnected {
            background-color: var(--danger-color);
        }

        .status-pending {
            background-color: var(--warning-color);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--secondary-color);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--secondary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .text-success {
            color: var(--secondary-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .balance-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .balance-card {
            background-color: white;
            border-radius: 5px;
            box-shadow: var(--shadow);
            padding: 15px;
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .balance-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .balance-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .balance-coin {
            font-weight: 500;
        }

        .activity-log {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-timestamp {
            color: var(--text-light);
            margin-right: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            width: 80%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .profit-positive {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .profit-negative {
            color: var(--danger-color);
            font-weight: 500;
        }

        .cooldown {
            color: var(--warning-color);
            font-style: italic;
        }

        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem 0;
            margin-top: 2rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr 1fr;
            }

            .balance-container {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }

        @media (max-width: 480px) {
            .control-panel {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                border-radius: 0;
                margin-right: 0;
                margin-bottom: 2px;
            }

            .tab.active {
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 2px;
            }

            .tab-content {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">Crypto Arbitrage Tool</a>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="history">Trade History</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Control Panel</h2>
                    </div>
                    <div class="card-body">
                        <div class="control-panel">
                            <div class="control-item">
                                <div class="control-label">Binance API</div>
                                <div class="control-value">
                                    <span class="status-indicator status-disconnected" id="binance-status"></span>
                                    <span id="binance-status-text">Not Configured</span>
                                </div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">OKX API</div>
                                <div class="control-value">
                                    <span class="status-indicator status-disconnected" id="okx-status"></span>
                                    <span id="okx-status-text">Not Configured</span>
                                </div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">WebSocket</div>
                                <div class="control-value">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="websocket-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Auto-Trade</div>
                                <div class="control-value">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="auto-trade-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Actions</div>
                                <div class="control-value">
                                    <button class="btn" id="refresh-btn">Refresh</button>
                                </div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Status</div>
                                <div class="control-value" id="status-text">Ready</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Arbitrage Opportunities</h2>
                    </div>
                    <div class="card-body">
                        <table id="opportunities-table">
                            <thead>
                                <tr>
                                    <th>Coin</th>
                                    <th>Buy Exchange</th>
                                    <th>Buy Price</th>
                                    <th>Sell Exchange</th>
                                    <th>Sell Price</th>
                                    <th>Diff %</th>
                                    <th>Amount</th>
                                    <th>Profit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="opportunities-body">
                                <tr>
                                    <td colspan="9" class="text-center">Loading opportunities...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="balance-container">
                    <div class="balance-card">
                        <div class="balance-header">
                            <div class="balance-title">Binance Balances</div>
                            <button class="btn" id="refresh-binance-btn">Refresh</button>
                        </div>
                        <div class="balance-list" id="binance-balances">
                            <div class="balance-item">
                                <div>Configure Binance API in Settings</div>
                            </div>
                        </div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-header">
                            <div class="balance-title">OKX Balances</div>
                            <button class="btn" id="refresh-okx-btn">Refresh</button>
                        </div>
                        <div class="balance-list" id="okx-balances">
                            <div class="balance-item">
                                <div>Configure OKX API in Settings</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Activity Log</h2>
                    </div>
                    <div class="card-body">
                        <div class="activity-log" id="activity-log">
                            <div class="log-entry">
                                <span class="log-timestamp">[2025-05-21 14:00:00]</span>
                                <span>Crypto Arbitrage Tool initialized</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Trade Statistics</h2>
                    </div>
                    <div class="card-body">
                        <div class="control-panel">
                            <div class="control-item">
                                <div class="control-label">Total Trades</div>
                                <div class="control-value" id="total-trades">0</div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Completed Trades</div>
                                <div class="control-value" id="completed-trades">0</div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Failed Trades</div>
                                <div class="control-value" id="failed-trades">0</div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Total Profit</div>
                                <div class="control-value" id="total-profit">$0.00</div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Avg Profit/Trade</div>
                                <div class="control-value" id="avg-profit">$0.00</div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Export</div>
                                <div class="control-value">
                                    <a href="/api/export_trades" class="btn" id="export-btn">Export CSV</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Trade History</h2>
                    </div>
                    <div class="card-body">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Coin</th>
                                    <th>Buy Exchange</th>
                                    <th>Sell Exchange</th>
                                    <th>Amount</th>
                                    <th>Profit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-body">
                                <tr>
                                    <td colspan="7" class="text-center">No trades yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">API Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-grid">
                            <div class="settings-section">
                                <h3 class="settings-title">Binance Testnet</h3>
                                <div class="form-group">
                                    <label for="binance-api-key">API Key</label>
                                    <input type="text" id="binance-api-key" placeholder="Enter Binance API Key">
                                </div>
                                <div class="form-group">
                                    <label for="binance-api-secret">API Secret</label>
                                    <input type="password" id="binance-api-secret" placeholder="Enter Binance API Secret">
                                </div>
                                <div class="form-group">
                                    <label for="binance-taker-fee">Taker Fee</label>
                                    <input type="number" id="binance-taker-fee" step="0.0001" min="0" max="0.01" value="0.001">
                                </div>
                            </div>
                            <div class="settings-section">
                                <h3 class="settings-title">OKX Demo Trading</h3>
                                <div class="form-group">
                                    <label for="okx-api-key">API Key</label>
                                    <input type="text" id="okx-api-key" placeholder="Enter OKX API Key">
                                </div>
                                <div class="form-group">
                                    <label for="okx-api-secret">API Secret</label>
                                    <input type="password" id="okx-api-secret" placeholder="Enter OKX API Secret">
                                </div>
                                <div class="form-group">
                                    <label for="okx-passphrase">Passphrase</label>
                                    <input type="password" id="okx-passphrase" placeholder="Enter OKX Passphrase">
                                </div>
                                <div class="form-group">
                                    <label for="okx-taker-fee">Taker Fee</label>
                                    <input type="number" id="okx-taker-fee" step="0.0001" min="0" max="0.01" value="0.001">
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="okx-demo-trading" checked>
                                        Use Demo Trading
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Trading Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-grid">
                            <div class="settings-section">
                                <h3 class="settings-title">General Settings</h3>
                                <div class="form-group">
                                    <label for="min-profit-threshold">Minimum Profit Threshold (USDT)</label>
                                    <input type="number" id="min-profit-threshold" step="0.01" min="0" value="0.09">
                                </div>
                                <div class="form-group">
                                    <label for="max-concurrent-trades">Maximum Concurrent Trades</label>
                                    <input type="number" id="max-concurrent-trades" step="1" min="1" max="10" value="3">
                                </div>
                                <div class="form-group">
                                    <label for="refresh-interval">Refresh Interval (seconds)</label>
                                    <input type="number" id="refresh-interval" step="1" min="5" max="60" value="10">
                                </div>
                                <div class="form-group">
                                    <label for="trade-cooldown">Trade Cooldown (seconds)</label>
                                    <input type="number" id="trade-cooldown" step="1" min="0" max="300" value="60">
                                </div>
                            </div>
                            <div class="settings-section">
                                <h3 class="settings-title">Auto-Trade Settings</h3>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="auto-trade-enabled">
                                        Enable Auto-Trading
                                    </label>
                                    <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">
                                        Auto-trading will automatically execute trades when profitable opportunities are found.
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="use-websocket">
                                        Use WebSocket for Real-time Updates
                                    </label>
                                    <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">
                                        WebSocket provides faster updates but may use more resources.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <button class="btn btn-success" id="save-settings-btn">Save Settings</button>
                            <button class="btn" id="reset-settings-btn">Reset to Defaults</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="trade-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Trade</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to execute this trade?</p>
                <table>
                    <tr>
                        <td><strong>Coin:</strong></td>
                        <td id="modal-coin"></td>
                    </tr>
                    <tr>
                        <td><strong>Buy:</strong></td>
                        <td id="modal-buy"></td>
                    </tr>
                    <tr>
                        <td><strong>Sell:</strong></td>
                        <td id="modal-sell"></td>
                    </tr>
                    <tr>
                        <td><strong>Amount:</strong></td>
                        <td id="modal-amount"></td>
                    </tr>
                    <tr>
                        <td><strong>Expected Profit:</strong></td>
                        <td id="modal-profit"></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-trade-btn">Cancel</button>
                <button class="btn btn-success" id="confirm-trade-btn">Execute Trade</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 Crypto Arbitrage Tool</p>
                <p>Version 1.0.0</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let config = {};
        let opportunities = [];
        let activeTrades = {};
        let selectedCoin = '';

        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const opportunitiesTable = document.getElementById('opportunities-body');
        const binanceBalances = document.getElementById('binance-balances');
        const okxBalances = document.getElementById('okx-balances');
        const activityLog = document.getElementById('activity-log');
        const historyTable = document.getElementById('history-body');
        const binanceStatus = document.getElementById('binance-status');
        const binanceStatusText = document.getElementById('binance-status-text');
        const okxStatus = document.getElementById('okx-status');
        const okxStatusText = document.getElementById('okx-status-text');
        const statusText = document.getElementById('status-text');
        const totalTrades = document.getElementById('total-trades');
        const completedTrades = document.getElementById('completed-trades');
        const failedTrades = document.getElementById('failed-trades');
        const totalProfit = document.getElementById('total-profit');
        const avgProfit = document.getElementById('avg-profit');
        const websocketToggle = document.getElementById('websocket-toggle');
        const autoTradeToggle = document.getElementById('auto-trade-toggle');
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshBinanceBtn = document.getElementById('refresh-binance-btn');
        const refreshOkxBtn = document.getElementById('refresh-okx-btn');
        const exportBtn = document.getElementById('export-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        const tradeModal = document.getElementById('trade-modal');
        const modalClose = document.querySelector('.close');
        const modalCoin = document.getElementById('modal-coin');
        const modalBuy = document.getElementById('modal-buy');
        const modalSell = document.getElementById('modal-sell');
        const modalAmount = document.getElementById('modal-amount');
        const modalProfit = document.getElementById('modal-profit');
        const cancelTradeBtn = document.getElementById('cancel-trade-btn');
        const confirmTradeBtn = document.getElementById('confirm-trade-btn');

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Add log entry
        function addLogEntry(message) {
            const now = new Date();
            const timestamp = now.toISOString().replace('T', ' ').substring(0, 19);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        // Format currency
        function formatCurrency(value) {
            return '$' + parseFloat(value).toFixed(6);
        }

        // Format percentage
        function formatPercentage(value) {
            return parseFloat(value).toFixed(2) + '%';
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                config = data.config;
                
                // Update UI based on config
                updateApiStatus();
                websocketToggle.checked = config.use_websocket;
                autoTradeToggle.checked = config.auto_trade;
                
                // Update settings form
                document.getElementById('binance-api-key').value = config.binance.api_key === true ? '********' : '';
                document.getElementById('binance-api-secret').value = config.binance.api_secret === true ? '********' : '';
                document.getElementById('binance-taker-fee').value = config.binance.taker_fee;
                
                document.getElementById('okx-api-key').value = config.okx.api_key === true ? '********' : '';
                document.getElementById('okx-api-secret').value = config.okx.api_secret === true ? '********' : '';
                document.getElementById('okx-passphrase').value = config.okx.passphrase === true ? '********' : '';
                document.getElementById('okx-taker-fee').value = config.okx.taker_fee;
                document.getElementById('okx-demo-trading').checked = config.okx.demo_trading;
                
                document.getElementById('min-profit-threshold').value = config.min_profit_threshold;
                document.getElementById('max-concurrent-trades').value = config.max_concurrent_trades;
                document.getElementById('refresh-interval').value = config.refresh_interval;
                document.getElementById('trade-cooldown').value = config.trade_cooldown;
                document.getElementById('auto-trade-enabled').checked = config.auto_trade;
                document.getElementById('use-websocket').checked = config.use_websocket;
                
                addLogEntry('Configuration loaded');
            } catch (error) {
                console.error('Error loading config:', error);
                addLogEntry('Error loading configuration');
            }
        }

        // Update API status indicators
        function updateApiStatus() {
            if (config.binance && config.binance.api_key && config.binance.api_secret) {
                binanceStatus.className = 'status-indicator status-connected';
                binanceStatusText.textContent = 'Connected';
            } else {
                binanceStatus.className = 'status-indicator status-disconnected';
                binanceStatusText.textContent = 'Not Configured';
            }
            
            if (config.okx && config.okx.api_key && config.okx.api_secret && config.okx.passphrase) {
                okxStatus.className = 'status-indicator status-connected';
                okxStatusText.textContent = 'Connected';
            } else {
                okxStatus.className = 'status-indicator status-disconnected';
                okxStatusText.textContent = 'Not Configured';
            }
        }

        // Load opportunities
        async function loadOpportunities() {
            try {
                statusText.textContent = 'Loading...';
                const response = await fetch('/api/opportunities');
                const data = await response.json();
                opportunities = data.opportunities;
                
                // Update opportunities table
                if (opportunities.length === 0) {
                    opportunitiesTable.innerHTML = '<tr><td colspan="9" class="text-center">No opportunities found</td></tr>';
                } else {
                    opportunitiesTable.innerHTML = '';
                    opportunities.forEach(opportunity => {
                        const row = document.createElement('tr');
                        
                        // Determine profit class
                        let profitClass = '';
                        if (opportunity.net_profit > 0) {
                            profitClass = 'profit-positive';
                        } else {
                            profitClass = 'profit-negative';
                        }
                        
                        // Create row content
                        row.innerHTML = `
                            <td>${opportunity.coin}</td>
                            <td>${opportunity.buy_exchange}</td>
                            <td>${opportunity.buy_price.toFixed(6)}</td>
                            <td>${opportunity.sell_exchange}</td>
                            <td>${opportunity.sell_price.toFixed(6)}</td>
                            <td>${opportunity.price_diff_pct.toFixed(2)}%</td>
                            <td>${opportunity.trade_amount}</td>
                            <td class="${profitClass}">${formatCurrency(opportunity.net_profit)}</td>
                            <td>
                                ${opportunity.in_cooldown ? 
                                    '<span class="cooldown">Cooldown</span>' : 
                                    `<button class="btn ${opportunity.profitable ? 'btn-success' : ''}" 
                                        data-coin="${opportunity.coin}" 
                                        ${!opportunity.profitable ? 'disabled' : ''}>
                                        Trade
                                    </button>`
                                }
                            </td>
                        `;
                        
                        opportunitiesTable.appendChild(row);
                    });
                    
                    // Add event listeners to trade buttons
                    document.querySelectorAll('#opportunities-body button').forEach(button => {
                        button.addEventListener('click', () => {
                            const coin = button.dataset.coin;
                            showTradeModal(coin);
                        });
                    });
                }
                
                statusText.textContent = 'Ready';
                addLogEntry('Opportunities updated');
            } catch (error) {
                console.error('Error loading opportunities:', error);
                opportunitiesTable.innerHTML = '<tr><td colspan="9" class="text-center">Error loading opportunities</td></tr>';
                statusText.textContent = 'Error';
                addLogEntry('Error loading opportunities');
            }
        }

        // Load balances
        async function loadBalances() {
            try {
                const response = await fetch('/api/balances');
                const data = await response.json();
                
                // Update Binance balances
                if (data.binance_balances && data.binance_balances.length > 0) {
                    binanceBalances.innerHTML = '';
                    data.binance_balances.forEach(balance => {
                        const balanceItem = document.createElement('div');
                        balanceItem.className = 'balance-item';
                        balanceItem.innerHTML = `
                            <div class="balance-coin">${balance.asset}</div>
                            <div class="balance-amount">Free: ${parseFloat(balance.free).toFixed(6)}, Locked: ${parseFloat(balance.locked).toFixed(6)}</div>
                        `;
                        binanceBalances.appendChild(balanceItem);
                    });
                } else {
                    binanceBalances.innerHTML = '<div class="balance-item"><div>No balances found or API not configured</div></div>';
                }
                
                // Update OKX balances
                if (data.okx_balances && data.okx_balances.length > 0) {
                    okxBalances.innerHTML = '';
                    data.okx_balances.forEach(balance => {
                        const balanceItem = document.createElement('div');
                        balanceItem.className = 'balance-item';
                        balanceItem.innerHTML = `
                            <div class="balance-coin">${balance.ccy}</div>
                            <div class="balance-amount">Available: ${parseFloat(balance.availBal).toFixed(6)}, Cash: ${parseFloat(balance.cashBal).toFixed(6)}</div>
                        `;
                        okxBalances.appendChild(balanceItem);
                    });
                } else {
                    okxBalances.innerHTML = '<div class="balance-item"><div>No balances found or API not configured</div></div>';
                }
                
                addLogEntry('Balances updated');
            } catch (error) {
                console.error('Error loading balances:', error);
                binanceBalances.innerHTML = '<div class="balance-item"><div>Error loading balances</div></div>';
                okxBalances.innerHTML = '<div class="balance-item"><div>Error loading balances</div></div>';
                addLogEntry('Error loading balances');
            }
        }

        // Load trade history
        async function loadTradeHistory() {
            try {
                const response = await fetch('/api/trade_history');
                const data = await response.json();
                
                // Update history table
                if (!data.trades || data.trades.length === 0) {
                    historyTable.innerHTML = '<tr><td colspan="7" class="text-center">No trades yet</td></tr>';
                } else {
                    historyTable.innerHTML = '';
                    data.trades.forEach(trade => {
                        const row = document.createElement('tr');
                        
                        // Determine status class
                        let statusClass = '';
                        if (trade.status === 'Completed') {
                            statusClass = 'text-success';
                        } else if (trade.status === 'Failed') {
                            statusClass = 'text-danger';
                        } else {
                            statusClass = 'text-warning';
                        }
                        
                        // Create row content
                        row.innerHTML = `
                            <td>${trade.timestamp}</td>
                            <td>${trade.coin}</td>
                            <td>${trade.buy_exchange}</td>
                            <td>${trade.sell_exchange}</td>
                            <td>${trade.amount}</td>
                            <td>${formatCurrency(trade.net_profit)}</td>
                            <td class="${statusClass}">${trade.status}</td>
                        `;
                        
                        historyTable.appendChild(row);
                    });
                }
                
                addLogEntry('Trade history updated');
            } catch (error) {
                console.error('Error loading trade history:', error);
                historyTable.innerHTML = '<tr><td colspan="7" class="text-center">Error loading trade history</td></tr>';
                addLogEntry('Error loading trade history');
            }
        }

        // Load trade statistics
        async function loadTradeStatistics() {
            try {
                const response = await fetch('/api/trade_statistics');
                const data = await response.json();
                
                if (data.statistics) {
                    totalTrades.textContent = data.statistics.total_trades;
                    completedTrades.textContent = data.statistics.completed_trades;
                    failedTrades.textContent = data.statistics.failed_trades;
                    totalProfit.textContent = formatCurrency(data.statistics.total_profit);
                    avgProfit.textContent = formatCurrency(data.statistics.avg_profit);
                }
                
                addLogEntry('Trade statistics updated');
            } catch (error) {
                console.error('Error loading trade statistics:', error);
                addLogEntry('Error loading trade statistics');
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                statusText.textContent = 'Saving...';
                
                // Prepare settings object
                const settings = {
                    binance: {
                        taker_fee: parseFloat(document.getElementById('binance-taker-fee').value)
                    },
                    okx: {
                        taker_fee: parseFloat(document.getElementById('okx-taker-fee').value),
                        demo_trading: document.getElementById('okx-demo-trading').checked
                    },
                    min_profit_threshold: parseFloat(document.getElementById('min-profit-threshold').value),
                    max_concurrent_trades: parseInt(document.getElementById('max-concurrent-trades').value),
                    refresh_interval: parseInt(document.getElementById('refresh-interval').value),
                    trade_cooldown: parseInt(document.getElementById('trade-cooldown').value),
                    auto_trade: document.getElementById('auto-trade-enabled').checked,
                    use_websocket: document.getElementById('use-websocket').checked
                };
                
                // Add API keys if they're not masked
                const binanceApiKey = document.getElementById('binance-api-key').value;
                const binanceApiSecret = document.getElementById('binance-api-secret').value;
                const okxApiKey = document.getElementById('okx-api-key').value;
                const okxApiSecret = document.getElementById('okx-api-secret').value;
                const okxPassphrase = document.getElementById('okx-passphrase').value;
                
                if (binanceApiKey && binanceApiKey !== '********') {
                    settings.binance.api_key = binanceApiKey;
                }
                
                if (binanceApiSecret && binanceApiSecret !== '********') {
                    settings.binance.api_secret = binanceApiSecret;
                }
                
                if (okxApiKey && okxApiKey !== '********') {
                    settings.okx.api_key = okxApiKey;
                }
                
                if (okxApiSecret && okxApiSecret !== '********') {
                    settings.okx.api_secret = okxApiSecret;
                }
                
                if (okxPassphrase && okxPassphrase !== '********') {
                    settings.okx.passphrase = okxPassphrase;
                }
                
                // Send settings to server
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusText.textContent = 'Settings saved';
                    addLogEntry('Settings saved successfully');
                    
                    // Update UI
                    await loadConfig();
                    
                    // Update toggles
                    websocketToggle.checked = settings.use_websocket;
                    autoTradeToggle.checked = settings.auto_trade;
                } else {
                    statusText.textContent = 'Error saving settings';
                    addLogEntry('Error saving settings: ' + data.message);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                statusText.textContent = 'Error';
                addLogEntry('Error saving settings');
            }
        }

        // Reset settings to defaults
        function resetSettings() {
            // Reset form fields to defaults
            document.getElementById('binance-taker-fee').value = 0.001;
            document.getElementById('okx-taker-fee').value = 0.001;
            document.getElementById('okx-demo-trading').checked = true;
            document.getElementById('min-profit-threshold').value = 0.09;
            document.getElementById('max-concurrent-trades').value = 3;
            document.getElementById('refresh-interval').value = 10;
            document.getElementById('trade-cooldown').value = 60;
            document.getElementById('auto-trade-enabled').checked = false;
            document.getElementById('use-websocket').checked = false;
            
            addLogEntry('Settings reset to defaults');
        }

        // Toggle WebSocket
        async function toggleWebSocket() {
            try {
                const enabled = websocketToggle.checked;
                
                const response = await fetch('/api/websocket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry(`WebSocket ${enabled ? 'enabled' : 'disabled'}`);
                    document.getElementById('use-websocket').checked = enabled;
                } else {
                    addLogEntry(`Error toggling WebSocket: ${data.message}`);
                    websocketToggle.checked = !enabled;
                }
            } catch (error) {
                console.error('Error toggling WebSocket:', error);
                addLogEntry('Error toggling WebSocket');
                websocketToggle.checked = !websocketToggle.checked;
            }
        }

        // Toggle Auto-Trade
        async function toggleAutoTrade() {
            try {
                const enabled = autoTradeToggle.checked;
                
                const response = await fetch('/api/auto_trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry(`Auto-Trade ${enabled ? 'enabled' : 'disabled'}`);
                    document.getElementById('auto-trade-enabled').checked = enabled;
                } else {
                    addLogEntry(`Error toggling Auto-Trade: ${data.message}`);
                    autoTradeToggle.checked = !enabled;
                }
            } catch (error) {
                console.error('Error toggling Auto-Trade:', error);
                addLogEntry('Error toggling Auto-Trade');
                autoTradeToggle.checked = !autoTradeToggle.checked;
            }
        }

        // Show trade confirmation modal
        function showTradeModal(coin) {
            selectedCoin = coin;
            
            // Find opportunity
            const opportunity = opportunities.find(o => o.coin === coin);
            
            if (opportunity) {
                modalCoin.textContent = opportunity.coin;
                modalBuy.textContent = `${opportunity.buy_price.toFixed(6)} on ${opportunity.buy_exchange}`;
                modalSell.textContent = `${opportunity.sell_price.toFixed(6)} on ${opportunity.sell_exchange}`;
                modalAmount.textContent = opportunity.trade_amount;
                modalProfit.textContent = formatCurrency(opportunity.net_profit);
                
                tradeModal.style.display = 'block';
            }
        }

        // Close trade modal
        function closeTradeModal() {
            tradeModal.style.display = 'none';
            selectedCoin = '';
        }

        // Execute trade
        async function executeTrade() {
            if (!selectedCoin) return;
            
            try {
                statusText.textContent = 'Executing trade...';
                closeTradeModal();
                
                const response = await fetch('/api/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coin: selectedCoin })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry(`Trade initiated for ${selectedCoin}: ${data.message}`);
                    statusText.textContent = 'Trade initiated';
                    
                    // Refresh data after a short delay
                    setTimeout(() => {
                        loadOpportunities();
                        loadBalances();
                        loadTradeHistory();
                        loadTradeStatistics();
                    }, 2000);
                } else {
                    addLogEntry(`Error executing trade: ${data.message}`);
                    statusText.textContent = 'Trade failed';
                }
            } catch (error) {
                console.error('Error executing trade:', error);
                addLogEntry('Error executing trade');
                statusText.textContent = 'Error';
            }
            
            selectedCoin = '';
        }

        // Refresh data
        function refreshData() {
            loadOpportunities();
            loadBalances();
            loadTradeHistory();
            loadTradeStatistics();
        }

        // Event listeners
        websocketToggle.addEventListener('change', toggleWebSocket);
        autoTradeToggle.addEventListener('change', toggleAutoTrade);
        refreshBtn.addEventListener('click', refreshData);
        refreshBinanceBtn.addEventListener('click', loadBalances);
        refreshOkxBtn.addEventListener('click', loadBalances);
        saveSettingsBtn.addEventListener('click', saveSettings);
        resetSettingsBtn.addEventListener('click', resetSettings);
        modalClose.addEventListener('click', closeTradeModal);
        cancelTradeBtn.addEventListener('click', closeTradeModal);
        confirmTradeBtn.addEventListener('click', executeTrade);

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === tradeModal) {
                closeTradeModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLogEntry('Crypto Arbitrage Tool initialized');
            loadConfig();
            loadOpportunities();
            loadBalances();
            loadTradeHistory();
            loadTradeStatistics();
            
            // Set up periodic refresh
            setInterval(refreshData, 30000);
        });
    </script>
</body>
</html>
